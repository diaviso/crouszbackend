generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String
  avatar    String?
  googleId  String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Professional profile
  jobTitle   String?
  specialty  String?
  skills     String[] @default([])
  bio        String?
  phone      String?
  linkedin   String?

  // Document header/letterhead (HTML)
  documentHeader String?

  ownedGroups     Group[]          @relation("GroupAdmin")
  memberships     GroupMember[]
  taskAssignments TaskAssignment[]
  messages        Message[]
  directMessages  DirectMessage[]
  attachments     Attachment[]
  notifications   Notification[]
  taskComments    TaskComment[]
  conversationParticipants ConversationParticipant[]
  messageReactions    MessageReaction[]
  directMessageReactions DirectMessageReaction[]
  documents       Document[]
  sharedDocuments DocumentShare[]
}

model Group {
  id          String   @id @default(uuid())
  name        String
  description String?
  isPublic    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  adminId  String
  admin    User          @relation("GroupAdmin", fields: [adminId], references: [id])
  members  GroupMember[]
  projects Project[]
  messages Message[]
}

enum GroupRole {
  ADMIN
  MEMBER
}

model GroupMember {
  id       String    @id @default(uuid())
  role     GroupRole @default(MEMBER)
  joinedAt DateTime  @default(now())

  userId  String
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  groupId String
  group   Group  @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([userId, groupId])
}

model Project {
  id          String   @id @default(uuid())
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  groupId     String
  group       Group        @relation(fields: [groupId], references: [id], onDelete: Cascade)
  tasks       Task[]
  attachments Attachment[]
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  DONE
}

model Task {
  id          String     @id @default(uuid())
  title       String
  description String?
  status      TaskStatus @default(TODO)
  dueDate     DateTime?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  projectId String
  project   Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  assignees TaskAssignment[]
  comments  TaskComment[]
}

model TaskAssignment {
  id         String   @id @default(uuid())
  assignedAt DateTime @default(now())

  taskId String
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([taskId, userId])
}

model Attachment {
  id           String   @id @default(uuid())
  filename     String
  originalName String
  mimeType     String
  size         Int
  createdAt    DateTime @default(now())

  projectId    String
  project      Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  uploadedById String
  uploadedBy   User    @relation(fields: [uploadedById], references: [id])
}

model Conversation {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  participants ConversationParticipant[]
  messages     DirectMessage[]
}

model ConversationParticipant {
  id        String   @id @default(uuid())
  joinedAt  DateTime @default(now())
  lastReadAt DateTime @default(now())

  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
}

model DirectMessage {
  id        String   @id @default(uuid())
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  isEdited  Boolean  @default(false)

  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  authorId       String
  author         User         @relation(fields: [authorId], references: [id])

  replyToId   String?
  replyTo     DirectMessage?  @relation("DirectMessageReplies", fields: [replyToId], references: [id], onDelete: SetNull)
  replies     DirectMessage[] @relation("DirectMessageReplies")

  attachments DirectMessageAttachment[]
  reactions   DirectMessageReaction[]
}

model DirectMessageAttachment {
  id           String   @id @default(uuid())
  filename     String
  originalName String
  mimeType     String
  size         Int
  url          String
  createdAt    DateTime @default(now())

  messageId String
  message   DirectMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
}

model DirectMessageReaction {
  id        String   @id @default(uuid())
  emoji     String
  createdAt DateTime @default(now())

  messageId String
  message   DirectMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  userId    String
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId, emoji])
}

model Message {
  id        String   @id @default(uuid())
  content   String
  mentions  String[] @default([])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  isEdited  Boolean  @default(false)

  groupId  String
  group    Group  @relation(fields: [groupId], references: [id], onDelete: Cascade)
  authorId String
  author   User   @relation(fields: [authorId], references: [id])

  replyToId   String?
  replyTo     Message?  @relation("MessageReplies", fields: [replyToId], references: [id], onDelete: SetNull)
  replies     Message[] @relation("MessageReplies")

  attachments MessageAttachment[]
  reactions   MessageReaction[]
}

model MessageAttachment {
  id           String   @id @default(uuid())
  filename     String
  originalName String
  mimeType     String
  size         Int
  url          String
  createdAt    DateTime @default(now())

  messageId String
  message   Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
}

model MessageReaction {
  id        String   @id @default(uuid())
  emoji     String
  createdAt DateTime @default(now())

  messageId String
  message   Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  userId    String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId, emoji])
}

enum NotificationType {
  TASK_ASSIGNED
  TASK_COMMENT
  MESSAGE_MENTION
  GROUP_INVITE
  GROUP_ROLE_CHANGED
  TASK_STATUS_CHANGED
  DOCUMENT_SHARED
}

model Notification {
  id        String           @id @default(uuid())
  type      NotificationType
  title     String
  message   String
  read      Boolean          @default(false)
  data      Json?
  createdAt DateTime         @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
}

model TaskComment {
  id        String   @id @default(uuid())
  content   String
  mentions  String[] @default([])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  taskId   String
  task     Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)
  authorId String
  author   User   @relation(fields: [authorId], references: [id])
}

model Document {
  id        String   @id @default(uuid())
  title     String
  content   String   @default("")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  authorId String
  author   User   @relation(fields: [authorId], references: [id], onDelete: Cascade)

  shares DocumentShare[]

  @@index([authorId])
}

model DocumentShare {
  id        String   @id @default(uuid())
  canEdit   Boolean  @default(false)
  createdAt DateTime @default(now())

  documentId String
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([documentId, userId])
}
